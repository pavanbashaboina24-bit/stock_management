<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Asset Management Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
        .view { display: none; animation: fadeIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .view.active { display: block; }
        .card-clean { transition: all 0.2s; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.02); }
        .card-clean:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); transform: translateY(-2px); }
        .chart-container { position: relative; width: 100%; max-width: 900px; margin-left: auto; margin-right: auto; height: 350px; max-height: 45vh; }
        @media (min-width: 768px) { .chart-container { height: 400px; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 50; animation: fadeIn 0.3s; }
        .modal-content { background: white; padding: 2.5rem; border-radius: 0.75rem; width: 95%; max-width: 700px; transform: scale(0.9); animation: zoomIn 0.3s forwards; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4); }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .table-row-clickable { cursor: pointer; }
    </style>
</head>
<body class="text-slate-800">

    <div id="login-modal" class="modal-overlay">
        <div class="modal-content max-w-sm p-8 text-center">
            <h3 class="text-3xl font-bold text-slate-900 mb-6">System Access</h3>
            <p class="text-slate-600 mb-6">Enter your credentials to continue.</p>
            <form id="login-form" class="space-y-4">
                <div>
                    <input type="text" id="login-username" placeholder="Username (e.g., admin, cse, civ)" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-teal-500 focus:border-teal-500 transition" required>
                </div>
                <div class="relative">
                    <input type="password" id="login-password" placeholder="Password" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-teal-500 focus:border-teal-500 transition" required>
                    <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 px-4 flex items-center text-slate-400 hover:text-slate-600">
                        <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="h-5 w-5" viewBox="0 0 16 16">
                            <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 7.88 3 12 3c4.12 0 7.88 1.668 9.167 2.957A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 8.119 13 4 13c-4.12 0-7.88-1.668-9.167-2.957A13.133 13.133 0 0 1 1.172 8z"/>
                            <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                        </svg>
                    </button>
                </div>
                <button type="submit" class="w-full bg-teal-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg shadow-teal-500/30 hover:bg-teal-700 transition transform hover:scale-[1.03]">
                    Secure Login
                </button>
                <div id="login-error" class="text-red-500 text-sm mt-2" style="display: none;">Invalid credentials. Please try again.</div>
            </form>
            <p class="mt-6 text-sm text-slate-500">
                <span class="font-bold">Admin:</span> admin/password<br>
                <span class="font-bold">Users:</span> cse/password, civ/password, etc.
            </p>
        </div>
    </div>

    <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-8 lg:p-12 hidden">
        <header class="mb-12 pb-4 border-b border-slate-200 flex flex-col sm:flex-row justify-between items-start sm:items-center">
            <div>
                <h1 class="text-3xl sm:text-5xl font-extrabold text-slate-900 tracking-tight">Asset Stock Management</h1>
                <p id="breadcrumb" class="text-slate-500 font-medium mt-3 text-base sm:text-lg">Centralized oversight for campus inventory.</p>
            </div>
            <div id="user-info" class="flex items-center space-x-4 mt-4 sm:mt-0">
                 <div id="role-display" class="px-4 py-2 bg-slate-100 rounded-full text-sm font-semibold">
                    Logged in as: <span class="text-teal-600">N/A</span>
                </div>
                <button id="logout-btn" class="bg-slate-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-slate-700 transition text-sm">Logout</button>
            </div>
        </header>

        <main>
            <section id="user-dashboard-view" class="view">
                <div class="mb-10">
                    <h2 id="user-dashboard-title" class="text-3xl font-bold text-slate-800">Department Dashboard</h2>
                    <p class="text-slate-600 mt-2">Please select an option to continue.</p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <button id="go-to-inventory-btn" class="bg-white p-8 rounded-lg card-clean border hover:border-teal-500 cursor-pointer text-center flex flex-col items-center justify-center">
                        <span class="text-5xl mb-4">üóÉÔ∏è</span>
                        <h3 class="text-xl font-bold text-slate-900">View Stationary</h3>
                        <p class="text-sm text-slate-500 mt-1">Browse stationary stock</p>
                    </button>
                    <button id="user-requests-btn" class="bg-white p-8 rounded-lg card-clean border hover:border-teal-500 cursor-pointer text-center flex flex-col items-center justify-center">
                         <span class="text-5xl mb-4">üìä</span>
                        <h3 class="text-xl font-bold text-slate-900">View Requests</h3>
                        <p class="text-sm text-slate-500 mt-1">Check the status of your item requests</p>
                    </button>
                    <button id="user-indent-btn" class="bg-white p-8 rounded-lg card-clean border hover:border-teal-500 cursor-pointer text-center flex flex-col items-center justify-center">
                         <span class="text-5xl mb-4">üìú</span>
                        <h3 class="text-xl font-bold text-slate-900">Create Indent</h3>
                        <p class="text-sm text-slate-500 mt-1">Submit a formal indent request</p>
                    </button>
                    <button id="go-to-stationary-upload-btn" class="bg-white p-8 rounded-lg card-clean border hover:border-teal-500 cursor-pointer text-center flex flex-col items-center justify-center">
                        <span class="text-5xl mb-4">üì¶</span>
                        <h3 class="text-xl font-bold text-slate-900">Upload Stationary</h3>
                        <p class="text-sm text-slate-500 mt-1">Request new items</p>
                    </button>
                </div>
            </section>

            <section id="departments-view" class="view">
                <div class="mb-10">
                    <h2 class="text-3xl font-bold text-slate-800">Select Departmental Stationary</h2>
                    <p class="text-slate-600 mt-2">Choose a department to begin your analysis.</p>
                </div>
                <div id="admin-dashboard-buttons" class="mb-10 p-4 bg-slate-100 rounded-lg" style="display: none;">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <button id="admin-assign-btn" class="bg-blue-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-600 transition">Assign Items</button>
                        <button id="admin-indents-btn" class="bg-indigo-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-600 transition">Manage Indents</button>
                        <button id="admin-stationary-upload-btn" class="bg-purple-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-purple-600 transition">Manage Stationary</button>
                    </div>
                </div>
                <div id="departments-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6"></div>
            </section>

            <section id="indent-options-view" class="view">
                <div class="mb-8">
                    <button id="back-from-indent-options" class="text-base font-semibold text-teal-600 hover:text-teal-800 transition flex items-center mb-6">
                        <span class="mr-1 text-xl">‚Üê</span> Back to Dashboard
                    </button>
                    <h2 class="text-4xl font-extrabold text-slate-900">Indent Management</h2>
                    <p class="text-slate-600 mt-2">Create a new indent form or check the status of existing indents.</p>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <button id="go-to-indent-form-btn" class="bg-white p-8 rounded-lg card-clean border hover:border-teal-500 cursor-pointer text-center flex flex-col items-center justify-center">
                        <span class="text-5xl mb-4">‚úçÔ∏è</span>
                        <h3 class="text-xl font-bold text-slate-900">Create New Indent Form</h3>
                        <p class="text-sm text-slate-500 mt-1">Fill out and submit a new list of required items.</p>
                    </button>
                    <button id="go-to-indent-status-btn" class="bg-white p-8 rounded-lg card-clean border hover:border-teal-500 cursor-pointer text-center flex flex-col items-center justify-center">
                        <span class="text-5xl mb-4">üìã</span>
                        <h3 class="text-xl font-bold text-slate-900">View Indent Status</h3>
                        <p class="text-sm text-slate-500 mt-1">Check the approval status of your submitted indents.</p>
                    </button>
                 </div>
            </section>

            <section id="indent-form-view" class="view">
                 <div class="mb-8">
                    <button id="back-from-indent-form" class="text-base font-semibold text-teal-600 hover:text-teal-800 transition flex items-center mb-6">
                        <span class="mr-1 text-xl">‚Üê</span> Back
                    </button>
                </div>
                <div class="bg-white p-8 rounded-lg card-clean border">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold text-slate-800">PRAGATI ENGINEERING COLLEGE</h2>
                        <p class="text-sm text-slate-600">(AUTONOMOUS)</p>
                        <p class="text-xs text-slate-500"># 1-378, ADB Road, SURAMPALEM - 533437, E.G.Dist., A.P.</p>
                        <h3 class="text-xl font-bold text-slate-800 mt-4 underline underline-offset-4">INDENT</h3>
                    </div>
                    <form id="indent-form">
                        <div class="grid grid-cols-3 gap-4 mb-4 text-sm">
                            <div><span class="font-semibold">Name of the Department:</span> <span id="indent-dept-name"></span></div>
                            <div><span class="font-semibold">No.:</span> <span id="indent-no"></span></div>
                            <div><span class="font-semibold">Date:</span> <span id="indent-date"></span></div>
                        </div>
                        <div class="border rounded-lg overflow-hidden">
                            <table class="min-w-full">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-semibold uppercase w-16">S.No</th>
                                        <th class="px-4 py-2 text-left text-xs font-semibold uppercase">Particulars</th>
                                        <th class="px-4 py-2 text-left text-xs font-semibold uppercase w-32">Quantity</th>
                                        <th class="px-4 py-2 text-center text-xs font-semibold uppercase w-24">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="indent-items-table" class="divide-y divide-slate-200"></tbody>
                            </table>
                        </div>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6 pt-4 border-t">
                             <div>
                                <label for="indent-ordered-by" class="block text-sm font-medium text-slate-700">Ordered by:</label>
                                <input type="text" id="indent-ordered-by" required class="w-full mt-1 p-2 border rounded-md">
                             </div>
                              <div>
                                <label class="block text-sm font-medium text-slate-500">Bill No.:</label>
                                <p class="mt-1 p-2 text-slate-500">(Admin Entry)</p>
                             </div>
                              <div>
                                <label class="block text-sm font-medium text-slate-500">Passed by:</label>
                                <p class="mt-1 p-2 text-slate-500">(Admin Entry)</p>
                             </div>
                        </div>
                        <div class="flex justify-between items-center mt-8">
                             <button type="button" id="add-indent-row-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">‚ûï Add Row</button>
                             <button type="submit" class="bg-teal-600 text-white font-semibold py-3 px-8 rounded-lg shadow-lg hover:bg-teal-700 transition">Submit Indent</button>
                        </div>
                    </form>
                </div>
            </section>

            <section id="indent-status-view" class="view">
                 <div class="mb-8">
                    <button id="back-from-indent-status" class="text-base font-semibold text-teal-600 hover:text-teal-800 transition flex items-center mb-6">
                        <span class="mr-1 text-xl">‚Üê</span> Back
                    </button>
                    <h2 class="text-4xl font-extrabold text-slate-900">Indent Status & Management</h2>
                </div>
                <div id="indent-history-admin-section" style="display: none;">
                    <h3 class="text-3xl font-bold text-slate-800 mb-6">Indent History</h3>
                     <div class="bg-white rounded-lg card-clean border overflow-x-auto mb-12">
                        <table class="min-w-full divide-y">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Indent No.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Department</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Items</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="indent-history-table" class="bg-white divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <h3 id="pending-indents-title" class="text-3xl font-bold text-slate-800 mb-6">My Indent Status</h3>
                    <div class="bg-white rounded-lg card-clean border overflow-x-auto">
                        <table class="min-w-full divide-y">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Indent No.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Department</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Items</th>
                                    <th id="indents-status-header" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="pending-indents-table" class="bg-white divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <section id="indent-review-view" class="view">
                <div class="mb-8">
                    <button id="back-from-indent-review" class="text-base font-semibold text-teal-600 hover:text-teal-800 transition flex items-center mb-6">
                        <span class="mr-1 text-xl">‚Üê</span> Back to Indent List
                    </button>
                    <h2 class="text-4xl font-extrabold text-slate-900">Review Indent</h2>
                    <div class="flex flex-col sm:flex-row sm:space-x-8 mt-2 text-sm text-slate-600">
                        <span><strong>Indent No:</strong> <span id="review-indent-no"></span></span>
                        <span><strong>Department:</strong> <span id="review-indent-dept"></span></span>
                        <span><strong>Date:</strong> <span id="review-indent-date"></span></span>
                        <span><strong>Ordered By:</strong> <span id="review-indent-ordered"></span></span>
                    </div>
                </div>
                <form id="indent-review-form">
                    <input type="hidden" id="review-indent-id">
                    <div class="bg-white rounded-lg card-clean border overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase w-16">S.No</th>
                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase">Particulars</th>
                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase w-32">Qty Requested</th>
                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase w-32">Qty Approved</th>
                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase w-48">Item Status</th>
                                </tr>
                            </thead>
                            <tbody id="indent-review-items-table" class="divide-y divide-slate-200">
                                </tbody>
                        </table>
                    </div>
                    <div class="flex justify-end mt-8">
                        <button type="submit" class="bg-teal-600 text-white font-semibold py-3 px-8 rounded-lg shadow-lg hover:bg-teal-700 transition">Process Indent</button>
                    </div>
                </form>
            </section>

            <section id="assign-view" class="view">
                <div class="mb-8">
                    <button id="back-from-assign" class="text-base font-semibold text-teal-600 hover:text-teal-800 transition flex items-center mb-6">
                        <span class="mr-1 text-xl">‚Üê</span> Back to Dashboard
                    </button>
                    <h2 class="text-4xl font-extrabold text-slate-900">Assign / Request Item</h2>
                    <p class="text-slate-600 mt-2">Log items that have been assigned to a person or location.</p>
                </div>
                <div class="bg-white p-6 rounded-lg card-clean border mb-12">
                    <form id="assign-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                        <div id="assign-department-group" class="md:col-span-1">
                            <label for="assign-department" class="block text-sm font-medium text-slate-700 mb-1">Department</label>
                            <select id="assign-department" class="w-full px-4 py-3 border border-slate-300 rounded-lg"></select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="assign-item" class="block text-sm font-medium text-slate-700 mb-1">Item(s)</label>
                            <select id="assign-item" required class="w-full px-4 py-3 border border-slate-300 rounded-lg">
                                <option value="" disabled selected>Select an item</option>
                                </select>
                        </div>
                        <div>
                            <label for="assign-quantity" class="block text-sm font-medium text-slate-700 mb-1">Quantity</label>
                            <input type="number" id="assign-quantity" min="1" required class="w-full px-4 py-3 border border-slate-300 rounded-lg">
                        </div>
                        <div>
                           <button type="submit" class="w-full bg-teal-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-teal-700 transition">Submit</button>
                        </div>
                    </form>
                </div>
                <div>
                    <h3 class="text-3xl font-bold text-slate-800 mb-6">Assignment History</h3>
                    <div class="bg-white rounded-lg card-clean border overflow-x-auto">
                        <table class="min-w-full divide-y">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Department</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Item(s)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Quantity</th>
                                </tr>
                            </thead>
                            <tbody id="assignment-history-table" class="bg-white divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <section id="requests-view" class="view">
                 <div class="mb-8">
                    <button id="back-from-requests" class="text-base font-semibold text-teal-600 hover:text-teal-800 transition flex items-center mb-6">
                        <span class="mr-1 text-xl">‚Üê</span> Back to Dashboard
                    </button>
                    <h2 class="text-4xl font-extrabold text-slate-900">Item Requests</h2>
                </div>
                <div id="request-history-admin-section">
                    <h3 class="text-3xl font-bold text-slate-800 mb-6">Request History</h3>
                     <div class="bg-white rounded-lg card-clean border overflow-x-auto mb-12">
                        <table class="min-w-full divide-y">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Department</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Item</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="request-history-table" class="bg-white divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <h3 id="pending-requests-title" class="text-3xl font-bold text-slate-800 mb-6">Pending Requests</h3>
                    <div class="bg-white rounded-lg card-clean border overflow-x-auto">
                        <table class="min-w-full divide-y">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Department</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Item</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Quantity</th>
                                    <th id="requests-status-header" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="pending-requests-table" class="bg-white divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="department-detail-view" class="view">
                <div class="mb-8">
                    <button id="back-to-depts" class="text-base font-semibold text-teal-600 hover:text-teal-800 transition flex items-center mb-6">
                        <span class="mr-1 text-xl">‚Üê</span> Back to All Departments
                    </button>
                    <button id="back-to-user-dashboard" class="text-base font-semibold text-teal-600 hover:text-teal-800 transition flex items-center mb-6">
                        <span class="mr-1 text-xl">‚Üê</span> Back to Dashboard
                    </button>
                    <h2 id="dept-title" class="text-4xl font-extrabold text-slate-900">Department Inventory</h2>
                    <p class="text-slate-600 mt-2">This dashboard summarizes asset distribution.</p>
                </div>
                <div class="bg-white p-6 rounded-lg card-clean mb-12 border border-slate-100">
                    <h3 class="text-2xl font-semibold mb-6 text-slate-700">Asset Count by Category</h3>
                    <div class="chart-container"><canvas id="department-chart"></canvas></div>
                </div>
                <h3 class="text-3xl font-bold text-slate-800 mb-6">Detailed Categories</h3>
                <div id="categories-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
            </section>

            <section id="category-detail-view" class="view">
                <div class="mb-8">
                    <button id="back-to-categories" class="text-base font-semibold text-teal-600 hover:text-teal-800 transition flex items-center mb-6">
                        <span class="mr-1 text-xl">‚Üê</span> Back to Asset Categories
                    </button>
                    <h2 id="category-title" class="text-4xl font-extrabold text-slate-900">Asset Register</h2>
                    <p class="text-slate-600 mt-2">View the detailed register for this asset category. <span id="admin-click-hint" class="text-sm text-amber-600 hidden font-medium">(Admin: Click a row to Edit)</span></p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
                    <div class="bg-white p-8 rounded-lg card-clean border border-slate-100 flex flex-col justify-center items-center text-center">
                        <h3 class="text-xl font-medium text-slate-500">TOTAL ITEMS</h3>
                        <p id="total-assets" class="text-7xl font-black text-teal-600 mt-2">0</p>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg card-clean border border-slate-100">
                        <h3 id="category-chart-title" class="text-xl font-bold text-slate-700 mb-4">Condition Composition</h3>
                        <div class="chart-container" style="height: 300px; max-height: 300px;"><canvas id="category-chart"></canvas></div>
                    </div>
                </div>
                <div id="admin-actions-bar" class="flex justify-between items-center mb-6" style="display: none;">
                    <div class="flex space-x-4">
                        <button id="action-add-item" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-full shadow-lg hover:bg-green-700 transition">‚ûï Add Item</button>
                        <div class="relative inline-block text-left">
                            <button id="bulk-action-btn" type="button" class="inline-flex justify-center w-full rounded-full border border-gray-300 px-6 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50" disabled>Bulk Actions (0)</button>
                            <div id="bulk-action-dropdown" class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white hidden">
                                <a href="#" id="bulk-status-btn" class="text-gray-700 block px-4 py-2 text-sm hover:bg-slate-100">Change Status...</a>
                                <a href="#" id="bulk-move-btn" class="text-gray-700 block px-4 py-2 text-sm hover:bg-slate-100">Move to Dept...</a>
                                <a href="#" id="bulk-delete-btn" class="text-red-600 block px-4 py-2 text-sm hover:bg-red-50">Bulk Delete</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-6">
                    <input type="text" id="search-input" placeholder="Search..." class="flex-grow px-4 py-3 border rounded-lg">
                    <select id="status-filter" class="px-4 py-3 border rounded-lg w-full sm:w-1/3">
                        <option value="All">Filter by Status: All</option>
                        <option value="Working">Working</option><option value="Not Working">Not Working</option><option value="Under Repair">Under Repair</option><option value="Discarded">Discarded</option>
                    </select>
                </div>
                <div class="bg-white rounded-lg card-clean border overflow-x-auto">
                    <table class="min-w-full divide-y">
                        <thead class="bg-slate-50">
                            <tr>
                                <th id="select-all-header" class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider" style="display:none;"><input type="checkbox" id="select-all-checkbox"></th>
                                <th id="item-id-header" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Item ID</th>
                                <th id="location-header" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Location</th>
                                <th id="brand-model-header" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Brand/Model</th>
                                <th id="item-name-header" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="display:none;">Item Name/Type</th>
                                <th id="condition-header" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Condition</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Quantity</th>
                                <th id="action-header" class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider" style="display:none;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="asset-table-body" class="bg-white divide-y"></tbody>
                    </table>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button id="download-current-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-full hover:bg-blue-700 transition">‚¨áÔ∏è Download Current View</button>
                    <button id="download-all-btn" class="bg-gray-600 text-white font-semibold py-2 px-6 rounded-full hover:bg-gray-700 transition">‚¨áÔ∏è Download Full Inventory</button>
                </div>
            </section>
            
            <section id="stationary-upload-view" class="view">
                <div class="mb-8">
                    <button id="back-from-stationary-upload" class="text-base font-semibold text-teal-600 hover:text-teal-800 transition flex items-center mb-6">
                        <span class="mr-1 text-xl">‚Üê</span> Back to Dashboard
                    </button>
                    <h2 id="stationary-upload-title" class="text-4xl font-extrabold text-slate-900">Upload New Stationary</h2>
                    <p id="stationary-upload-desc" class="text-slate-600 mt-2">Request new stationary items to be approved by the admin.</p>
                </div>

                <div id="stationary-upload-form-container" class="bg-white p-6 rounded-lg card-clean border mb-12">
                    <h3 class="text-2xl font-bold text-slate-800 mb-6">Add New Stationary Request</h3>
                    <form id="stationary-upload-form" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div>
                            <label for="other-name" class="block text-sm font-medium text-slate-700 mb-1">Item Name</label>
                            <input type="text" id="other-name" placeholder="e.g., Lab Equipment" required class="w-full px-4 py-3 border border-slate-300 rounded-lg">
                        </div>
                        <div>
                            <label for="other-quantity" class="block text-sm font-medium text-slate-700 mb-1">Quantity</label>
                            <input type="number" id="other-quantity" min="1" required class="w-full px-4 py-3 border border-slate-300 rounded-lg">
                        </div>
                        <div class="md:col-span-2">
                            <label for="other-desc" class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                            <textarea id="other-desc" rows="1" placeholder="Item description or specifications..." class="w-full px-4 py-3 border border-slate-300 rounded-lg"></textarea>
                        </div>
                        <div class="md:col-span-4 flex justify-end">
                           <button type="submit" class="bg-teal-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-teal-700 transition">Submit Request</button>
                        </div>
                    </form>
                </div>

                <div id="stationary-pending-section" style="display: none;">
                    <h3 class="text-3xl font-bold text-slate-800 mb-6">Pending Stationary Requests</h3>
                    <div class="bg-white rounded-lg card-clean border overflow-x-auto mb-12">
                        <table class="min-w-full divide-y">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Department</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Description</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Quantity</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody id="stationary-pending-table-body" class="bg-white divide-y divide-slate-100">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div>
                    <h3 id="stationary-list-title" class="text-3xl font-bold text-slate-800 mb-6">My Stationary Requests</h3>
                    <div class="bg-white rounded-lg card-clean border overflow-x-auto">
                        <table class="min-w-full divide-y">
                            <thead class="bg-slate-50">
                                <tr id="stationary-list-header-row">
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Description</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Quantity</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="stationary-upload-table-body" class="bg-white divide-y divide-slate-100">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="asset-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 id="modal-title" class="text-2xl font-bold mb-6">Asset Record</h3>
            <form id="asset-form" class="space-y-4">
                <input type="hidden" id="modal-operation"><input type="hidden" id="asset-original-id">
                <div id="delete-message" class="bg-red-50 border border-red-200 text-red-700 p-4 rounded-lg hidden">
                    <p class="font-semibold">‚ö†Ô∏è Warning:</p><p>This action is permanent and cannot be undone.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="asset-name-static" class="block text-sm font-medium">Particulars</label>
                        <input type="text" id="asset-name-static" readonly class="w-full px-4 py-3 border rounded-lg bg-slate-100">
                    </div>
                    <div>
                        <label for="asset-quantity" class="block text-sm font-medium">Quantity</label>
                        <input type="number" id="asset-quantity" min="0" required class="w-full px-4 py-3 border rounded-lg">
                    </div>
                    <div id="asset-id-group" style="display:none;"><label for="asset-id" class="block text-sm font-medium">Asset ID</label><input type="text" id="asset-id" class="w-full px-4 py-3 border rounded-lg"></div>
                    <div id="asset-location-group" style="display:none;"><label for="asset-location" class="block text-sm font-medium">Location</label><input type="text" id="asset-location" class="w-full px-4 py-3 border rounded-lg"></div>
                    <div id="asset-brand-group" style="display:none;"><label for="asset-brand" class="block text-sm font-medium">Brand/Model</label><input type="text" id="asset-brand" class="w-full px-4 py-3 border rounded-lg"></div>
                    <div id="asset-status-group" style="display:none;"><label for="asset-status" class="block text-sm font-medium">Condition</label><select id="asset-status" class="w-full px-4 py-3 border rounded-lg"><option value="Working">Working</option><option value="Not Working">Not Working</option><option value="Under Repair">Under Repair</option><option value="Discarded">Discarded</option></select></div>
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="cancel-modal-btn" class="bg-slate-200 font-semibold py-3 px-6 rounded-lg">Cancel</button>
                    <button type="submit" id="modal-submit-btn" class="bg-teal-600 text-white font-semibold py-3 px-6 rounded-lg">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="bulk-action-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content max-w-md">
            <h3 id="bulk-modal-title" class="text-2xl font-bold mb-6">Bulk Action</h3>
            <p class="mb-4">Applying action to <span id="bulk-item-count" class="font-bold text-teal-600">0</span> items.</p>
            <form id="bulk-action-form" class="space-y-4">
                <input type="hidden" id="bulk-operation-type">
                <div id="bulk-status-group" style="display:none;"><label for="bulk-new-status" class="block text-sm font-medium">New Status</label><select id="bulk-new-status" required class="w-full px-4 py-3 border rounded-lg"><option value="Working">Working</option><option value="Not Working">Not Working</option><option value="Under Repair">Under Repair</option><option value="Discarded">Discarded</option></select></div>
                <div id="bulk-move-group" style="display:none;"><label for="bulk-new-dept" class="block text-sm font-medium">New Department</label><select id="bulk-new-dept" required class="w-full px-4 py-3 border rounded-lg"></select></div>
                <div id="bulk-delete-group" class="bg-red-50 border p-4 rounded-lg hidden"><p class="font-semibold">‚ö†Ô∏è This will permanently delete <span id="bulk-delete-count" class="font-bold">0</span> records.</p></div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="bulk-cancel-btn" class="bg-slate-200 font-semibold py-3 px-6 rounded-lg">Cancel</button>
                    <button type="submit" id="bulk-submit-btn" class="bg-teal-600 text-white font-semibold py-3 px-6 rounded-lg">Confirm</button>
                </div>
            </form>
        </div>
    </div>
    <div id="toast" class="hidden fixed right-6 bottom-6 bg-slate-900 text-white px-4 py-2 rounded-lg shadow-lg" style="opacity:0; transition:opacity 0.35s ease;"></div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA DEFINITIONS ---
        const DEPARTMENTS = ['CIV', 'EEE', 'MEC', 'ECE', 'CSE', 'CAI', 'CSM', 'CSE DS', 'CS', 'IT'];
        
        // --- NEW STATIONARY LIST ---
        const STATIONARY_LIST = [
            "A/4 PAPER (70 GSM)", "A/4COLOURPAPER(500P)", "BELL CLIPS COLOUR", "BELL CLIPS SMALL", "BOX FILES BIG", 
            "BOX FILES SMALL", "C D MARKERS", "CUTTERS", "TIGER D/C PAPER", "DUSTERS", "DUSTLESS CHALKPIECES WHITE", 
            "DUSTLESS COLOUR CHALK", "ERASERS", "FEVICOL 200GMS", "FOLDERS F.S", "FOLDERS A 4", 
            "FOLDERS P.P. A/4(150 M.C.)", "GUM STICKS MEDIUM", "GUMS 700ML CAMEL", "GUMS DAYTONE", 
            "HIGHLITER PENS", "L FOLDERS", "LONG BOOKS (100P)A.P", "LONG BOOKS 160P. A.P", 
            "LONG NOTE BOOK RULED(BIND)NO.5", "LONG NOTE BOOK RULED(BIND)NO.2", "LONG NOTE BOOK RULED(BIND)NO.3", 
            "LONG NOTE BOOK RULED(BIND)NO.4", "MAHABAR 380P.BOOKS", "NOTICE BOARD PINS", "PACKING WIRE", 
            "PENCILS", "PENS (D.F.)", "PENS (D.F.) BLACK", "PENS (D.F.) BLUE", "PENS (D.F.) RED", "PP COVERS", 
            "PUNCHING MACHINE BIG", "PUNCHING MACHINE DOUBLE HOLE", "PVC FILES", "RUBBER BANDS (500 GMS) SPL", 
            "SCISSORS BIG", "SHARPNER", "SHORT BOOKS", "SKETCH PENS SETS(BIG)", "SPONZE DUMPERS", 
            "STAMP PAD INKS SMALL", "STAMP PADS MEDIUM", "STAPPLER PINS 24/6", "STAPPLER PINS NO 10", 
            "STAPPLERS HP 45", "STAPPLERS NO 10", "STEEL SCALE LONG (METEL)", "STICK FILES A4", 
            "SKETCH PEN PKS", "TAGS 8RL (BUNDELS)", "TAPES BIG (BRN&TRN) 200 M", "TAPES BIG(BROWN)", 
            "THREAD (5PLY)(COTTON) (NO 2 SPL)", "WHITE FLUID(CORRECTION PEN)", "OTHERS"
        ];
        
        // These old constants are now replaced by the one above
        const RAW_CATEGORIES = STATIONARY_LIST;
        const GROUPED_CATEGORIES = ['Stationary']; // We now only have one main category
        const CONSUMABLES = []; 
        const STATUS_OPTIONS = ['Working', 'Not Working', 'Under Repair', 'Discarded'];
        const BRANDS = {}; // No longer needed
        
        let appData = {}, assignmentHistory = [], requestsLog = [], indentsLog = [];
        let stationaryUploadData = []; // RENAMED
        let stationaryRequestsLog = []; // NEW: For stationary approval workflow
        let currentUserRole = null, departmentChart = null, categoryChart = null;
        let state = { currentView: 'departments-view', department: null, category: null, searchText: '', filterStatus: 'All', selectedItems: new Set() };
        
        // --- DOM ELEMENTS ---
        const loginModal = document.getElementById('login-modal');
        const appContainer = document.getElementById('app-container');
        const roleDisplay = document.getElementById('role-display').querySelector('span');
        const breadcrumbEl = document.getElementById('breadcrumb');
        const views = document.querySelectorAll('.view');
        
        // --- DATA PERSISTENCE ---
        const loadData = () => {
            // *** DATA FIX: Change this key to force a refresh ***
            const storedData = localStorage.getItem('collegeAssetData_v3'); 
            const storedHistory = localStorage.getItem('assignmentHistory');
            const storedRequests = localStorage.getItem('requestsLog');
            const storedIndents = localStorage.getItem('indentsLog');
            
            if (storedData) { 
                appData = JSON.parse(storedData); 
            } else {
                appData = generateMockData(); // Assign the return value
            }
            
            // *** DATA FIX: Check if logs are empty and if so, load mock data ***
            assignmentHistory = JSON.parse(storedHistory) || (appData && generateMockHistory());
            requestsLog = JSON.parse(storedRequests) || (appData && generateMockRequests());
            indentsLog = JSON.parse(storedIndents) || (appData && generateMockIndents());
            stationaryUploadData = JSON.parse(localStorage.getItem('stationaryUploadData')) || []; // RENAMED
            stationaryRequestsLog = JSON.parse(localStorage.getItem('stationaryRequestsLog')) || []; // NEW
        };
        const saveData = () => {
            // *** DATA FIX: Change this key ***
            localStorage.setItem('collegeAssetData_v3', JSON.stringify(appData));
            localStorage.setItem('assignmentHistory', JSON.stringify(assignmentHistory));
            localStorage.setItem('requestsLog', JSON.stringify(requestsLog));
            localStorage.setItem('indentsLog', JSON.stringify(indentsLog));
            localStorage.setItem('stationaryUploadData', JSON.stringify(stationaryUploadData)); // RENAMED
            localStorage.setItem('stationaryRequestsLog', JSON.stringify(stationaryRequestsLog)); // NEW
        };

        const generateMockData = () => {
            let newData = {};
            DEPARTMENTS.forEach(dept => {
                newData[dept] = {
                    'Stationary': [] // Create one single category
                };
                // For each item in the real list, add it to the department's stationary
                STATIONARY_LIST.forEach((item_name, i) => {
                    newData[dept]['Stationary'].push({
                        id: `${dept}-ST-${String(i+1).padStart(3,'0')}`, // This ID is not really used anymore but is good practice
                        name: item_name,
                        quantity: Math.floor(Math.random() * 500) + 50 // Give it a random stock quantity
                    });
                });
            });
            localStorage.setItem('collegeAssetData_v3', JSON.stringify(newData));
            return newData;
        };
        
        // --- Functions to generate mock logs ---
        const generateMockRequests = () => {
            let mockLogs = [
                {id: 1, date: "01/10/2025", department: "cse", item: "PENS (D.F.) BLUE", quantity: 10, status: "Pending"},
                {id: 2, date: "02/10/2025", department: "civ", item: "A/4 PAPER (70 GSM)", quantity: 5, status: "Approved"},
                {id: 3, date: "03/10/2025", department: "cse", item: "STAPPLERS HP 45", quantity: 1, status: "Rejected"},
            ];
            localStorage.setItem('requestsLog', JSON.stringify(mockLogs));
            return mockLogs;
        };
        const generateMockHistory = () => {
            let mockHistory = [
                {id: 2, date: "02/10/2025", department: "civ", item: "A/4 PAPER (70 GSM)", quantity: 5, status: "Approved"}
            ];
            localStorage.setItem('assignmentHistory', JSON.stringify(mockHistory));
            return mockHistory;
        };
        const generateMockIndents = () => {
            let mockIndents = [
                {id: "IND-123456", date: "01/10/2025", department: "cse", orderedBy: "User", items: [{item: "A/4 PAPER (70 GSM)", quantity: "5"}, {item: "LONG BOOKS (100P)A.P", quantity: "20"}], status: "Pending"},
                {id: "IND-123457", date: "02/10/2025", department: "cse", orderedBy: "User", items: [{item: "PENS (D.F.) BLUE", quantity: "10"}], status: "In Progress", itemStatus: "Partial", approvedQty: "5"},
                {id: "IND-123458", date: "28/09/2025", department: "cse", orderedBy: "User", items: [{item: "DUSTERS", quantity: "2"}], status: "Solved", itemStatus: "Approved", approvedQty: "2"},
            ];
            localStorage.setItem('indentsLog', JSON.stringify(mockIndents));
            return mockIndents;
        };
        // --- END DATA FIX ---

        // --- AUTHENTICATION & NAVIGATION ---
        const handleLogin = (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value.toLowerCase().trim();
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            const departmentUserMatch = DEPARTMENTS.find(d => d.toLowerCase() === username);
            if (username === 'admin' && password === 'password') { setRole('Admin'); errorEl.style.display = 'none'; } 
            else if (departmentUserMatch && password === 'password') { setRole('User', departmentUserMatch); errorEl.style.display = 'none'; } 
            else { errorEl.style.display = 'block'; }
        };

        const setRole = (role, department = null) => {
            currentUserRole = role;
            roleDisplay.textContent = role === 'User' ? `User (${department})` : 'Admin';
            loginModal.style.display = 'none';
            appContainer.classList.remove('hidden');
            document.getElementById('admin-dashboard-buttons').style.display = role === 'Admin' ? 'block' : 'none';
            if (role === 'User' && department) { state.department = department; renderUserDashboard(); navigate('user-dashboard-view'); } 
            else { state.department = null; renderDepartments(); navigate('departments-view'); }
        };

        const handleLogout = () => {
            currentUserRole = null; state.department = null; state.category = null;
            loginModal.style.display = 'flex'; appContainer.classList.add('hidden');
            document.getElementById('login-form').reset();
        };
        
        const navigate = (viewId) => {
            state.currentView = viewId;
            views.forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            updateBreadcrumb();
        };

        const updateBreadcrumb = () => {
            let path = '';
            // RENAMED: 'others-view' -> 'stationary-upload-view'
            if (currentUserRole === 'Admin' && !['assign-view', 'requests-view', 'indent-status-view', 'indent-form-view', 'indent-options-view', 'indent-review-view', 'stationary-upload-view', 'category-detail-view'].includes(state.currentView)) path = '<span class="text-teal-600 font-bold">Dashboard</span>';
            if (state.department && currentUserRole === 'User' && state.currentView !== 'category-detail-view') path = '<span class="text-teal-600 font-bold">Dashboard</span>'
            if (state.department && currentUserRole === 'Admin' && state.currentView !== 'category-detail-view') path += ` / <span class="text-slate-700">${state.department}</span>`;
            
            if (state.currentView === 'category-detail-view') {
                path += ` / <a href="#" id="breadcrumb-dashboard-link" class="text-teal-600 hover:text-teal-800">Dashboard</a> / <span class="text-slate-900 font-bold">${state.department} Stationary</span>`;
            }
            if (state.currentView === 'assign-view') path += ' / <span class="text-slate-900 font-bold">Request Item</span>';
            if (state.currentView === 'requests-view') path += ' / <span class="text-slate-900 font-bold">View Requests</span>';
            if (state.currentView.startsWith('indent-')) path += ' / <span class="text-slate-900 font-bold">Indent</span>';
            if (state.currentView === 'stationary-upload-view') path += ' / <span class="text-slate-900 font-bold">Upload Stationary</span>';
            
            breadcrumbEl.innerHTML = path.startsWith(' / ') ? path.substring(3) : path;
            
            const breadcrumbDashboardLink = document.getElementById('breadcrumb-dashboard-link');
            if(breadcrumbDashboardLink) {
                breadcrumbDashboardLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigate(currentUserRole === 'Admin' ? 'departments-view' : 'user-dashboard-view');
                });
            }
        };

        const showToast = (message, duration = 3000) => {
            let toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.remove('hidden'); toast.style.opacity = '1';
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, duration);
        };
        
        // --- DATA HELPERS ---
        // UPDATED: This is now simple.
        const getCategoryAssets = (dept, cat) => appData[dept]?.[cat] || [];
        
        // UPDATED: This now searches the new data structure
        const findAssetReference = (itemName) => {
            // This function is now used to find a stationary item by its *name*
            const dept = state.department;
            if (appData[dept] && appData[dept].Stationary) {
                const index = appData[dept].Stationary.findIndex(a => a.name === itemName);
                if (index !== -1) return { dept, cat: 'Stationary', index, asset: appData[dept].Stationary[index] };
            }
            return null;
        };
        
        // --- CORE RENDER FUNCTIONS ---
        const renderUserDashboard = () => document.getElementById('user-dashboard-title').textContent = `${state.department} Department Dashboard`;
        const renderDepartments = () => {
            const grid = document.getElementById('departments-grid');
            grid.innerHTML = '';
            DEPARTMENTS.forEach(dept => {
                let totalAssets = getCategoryAssets(dept, 'Stationary').reduce((acc, item) => acc + item.quantity, 0);
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-lg card-clean border hover:border-teal-500 cursor-pointer';
                card.innerHTML = `<h3 class="text-xl font-bold pb-2 mb-2">${dept}</h3><p class="text-3xl font-extrabold text-teal-600">${totalAssets}</p><p class="text-sm text-slate-500 mt-1 font-medium">Total Stationary</p>`;
                // UPDATED: This now goes directly to the item list (category-detail-view)
                card.addEventListener('click', () => { 
                    state.department = dept; 
                    state.category = 'Stationary';
                    renderCategoryDetail(); 
                    navigate('category-detail-view'); 
                });
                grid.appendChild(card);
            });
        };
        
        // This function is NO LONGER USED
        const renderDepartmentDetail = () => {
            console.warn("renderDepartmentDetail is deprecated. Navigating to item list instead.");
            state.category = 'Stationary';
            renderCategoryDetail(); 
            navigate('category-detail-view');
        };
        
        // This function is now the main "Stationary Stock" page
        const renderCategoryDetail = () => {
            document.getElementById('category-title').textContent = `${state.department} Stationary Stock`;
            const allAssets = getCategoryAssets(state.department, state.category);
            
            // This is no longer relevant
            document.getElementById('total-assets').textContent = allAssets.length;
            
            renderTable(allAssets);
            
            // This chart is no longer relevant
            // renderCategoryChart(allAssets); 
        };

        const renderTable = (assets) => {
            const tbody = document.getElementById('asset-table-body');
            const isAdmin = currentUserRole === 'Admin';
            
            // Show/Hide the correct headers
            document.getElementById('action-header').style.display = isAdmin ? '' : 'none';
            ['item-id-header', 'location-header', 'brand-model-header', 'condition-header', 'item-name-header', 'select-all-header'].forEach(id => {
                if (document.getElementById(id)) document.getElementById(id).style.display = 'none';
            });
            // Make sure the visible headers are correct (S.No, Particulars, Quantity, Action)
            // The headers are static HTML, so we just hide the ones we don't want.
            
            tbody.innerHTML = '';

            if (assets.length === 0) { 
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-slate-500">No stationary found for this department.</td></tr>`; 
                return; 
            }
            
            let serialNo = 1;
            assets.forEach(asset => {
                const row = document.createElement('tr');
                row.className = `transition ${isAdmin ? 'table-row-clickable hover:bg-teal-50' : 'hover:bg-slate-50'}`;
                
                let actionButton = isAdmin ? `<td class="px-6 py-4 text-center"><button data-name="${asset.name}" class="edit-quantity-btn text-teal-600 font-semibold text-sm">Edit</button></td>` : '';
                
                row.innerHTML = `
                    <td class="px-6 py-4">${serialNo++}</td>
                    <td class="px-6 py-4 font-semibold">${asset.name}</td>
                    <td class="px-6 py-4">${asset.quantity}</td>
                    ${actionButton}
                `;
                tbody.appendChild(row);
                
                if (isAdmin) {
                    row.querySelector('.edit-quantity-btn')?.addEventListener('click', (e) => { 
                        e.stopPropagation(); 
                        openModal('edit', asset); 
                    });
                }
            });
        };

        // --- ASSIGNMENT & REQUESTS ---
        const showAssignView = () => {
            const deptGroup = document.getElementById('assign-department-group');
            const deptSelect = document.getElementById('assign-department');
            // UPDATED: Populate with real stationary list
            const itemSelect = document.getElementById('assign-item');
            itemSelect.innerHTML = `<option value="" disabled selected>Select an item</option>` + STATIONARY_LIST.map(c => `<option value="${c}">${c}</option>`).join('');
            
            if (currentUserRole === 'Admin') { 
                deptGroup.style.display = 'block'; 
                deptSelect.innerHTML = DEPARTMENTS.map(d => `<option value="${d}">${d}</option>`).join(''); 
            } 
            else { 
                deptGroup.style.display = 'none'; 
            }
            renderAssignmentHistory();
            navigate('assign-view');
        };

        const handleAssignmentSubmit = (e) => {
            e.preventDefault();
            const isRequest = currentUserRole === 'User';
            const newEntry = {
                id: Date.now(),
                date: new Date().toLocaleDateString('en-IN'),
                department: currentUserRole === 'Admin' ? document.getElementById('assign-department').value : state.department,
                item: document.getElementById('assign-item').value,
                quantity: document.getElementById('assign-quantity').value,
                status: isRequest ? 'Pending' : 'Approved'
            };
            if (isRequest) {
                requestsLog.unshift(newEntry);
                saveData(); // Use main save function
                showToast('Request submitted successfully!');
            } else { // Admin direct assignment
                assignmentHistory.unshift(newEntry);
                requestsLog.unshift(newEntry);
                saveData(); // Use main save function
                showToast('Assignment logged successfully!');
            }
            document.getElementById('assign-form').reset();
            if(!isRequest) renderAssignmentHistory();
        };

        const renderAssignmentHistory = () => {
            const tbody = document.getElementById('assignment-history-table');
            tbody.innerHTML = '';
            const historyToRender = currentUserRole === 'Admin' ? assignmentHistory : assignmentHistory.filter(entry => entry.department === state.department);
            if (historyToRender.length === 0) { tbody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-slate-500">No assignment history found.</td></tr>`; return; }
            historyToRender.forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `<td class="px-6 py-4">${entry.date}</td><td class="px-6 py-4 font-semibold">${entry.department}</td><td class="px-6 py-4">${entry.item}</td><td class="px-6 py-4">${entry.quantity}</td>`;
                tbody.appendChild(row);
            });
        };

        const showRequestsView = () => {
            const isAdmin = currentUserRole === 'Admin';
            document.getElementById('request-history-admin-section').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('requests-status-header').textContent = isAdmin ? 'Action' : 'Status';
            document.getElementById('pending-requests-title').textContent = isAdmin ? 'Pending Requests' : 'My Requests';
            if (isAdmin) renderRequestHistory();
            renderPendingRequests();
            navigate('requests-view');
        };
        
        const renderRequestHistory = () => {
             const tbody = document.getElementById('request-history-table');
             tbody.innerHTML = '';
             const history = requestsLog.filter(r => r.status !== 'Pending');
             if (history.length === 0) { tbody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-slate-500">No historical requests found.</td></tr>`; return; }
             history.forEach(req => {
                const statusColor = req.status === 'Approved' ? 'text-green-600' : 'text-red-600';
                const row = document.createElement('tr');
                row.innerHTML = `<td class="px-6 py-4">${req.date}</td><td class="px-6 py-4 font-semibold">${req.department}</td><td class="px-6 py-4">${req.item}</td><td class="px-6 py-4 font-bold ${statusColor}">${req.status}</td>`;
                tbody.appendChild(row);
             });
        };
        
        const renderPendingRequests = () => {
            const tbody = document.getElementById('pending-requests-table');
            const isAdmin = currentUserRole === 'Admin';
            tbody.innerHTML = '';
            const pending = isAdmin ? requestsLog.filter(r => r.status === 'Pending') : requestsLog.filter(r => r.department === state.department);
            if (pending.length === 0) { tbody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-slate-500">No pending requests.</td></tr>`; return; }
            pending.forEach(req => {
                const row = document.createElement('tr');
                let statusCell = `<td class="px-6 py-4 font-semibold text-yellow-600">${req.status}</td>`;
                if(isAdmin) {
                    statusCell = `<td class="px-6 py-4 space-x-2"><button data-request-id="${req.id}" class="accept-btn bg-green-500 text-white px-3 py-1 rounded-md text-sm">Accept</button><button data-request-id="${req.id}" class="reject-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm">Reject</button></td>`;
                }
                row.innerHTML = `<td class="px-6 py-4">${req.date}</td><td class="px-6 py-4 font-semibold">${req.department}</td><td class="px-6 py-4">${req.item}</td><td class="px-6 py-4">${req.quantity}</td>${statusCell}`;
                tbody.appendChild(row);
            });
            document.querySelectorAll('.accept-btn').forEach(btn => btn.addEventListener('click', (e) => handleRequestAction(e.target.dataset.requestId, 'Approved')));
            document.querySelectorAll('.reject-btn').forEach(btn => btn.addEventListener('click', (e) => handleRequestAction(e.target.dataset.requestId, 'Rejected')));
        };
        
        const handleRequestAction = (requestId, action) => {
            const request = requestsLog.find(r => r.id == requestId);
            if(!request) return;
            request.status = action;
            if (action === 'Approved') {
                assignmentHistory.unshift({ ...request });
            }
            saveData(); // Use main save function
            showRequestsView();
            showToast(`Request has been ${action.toLowerCase()}!`);
        };

        // --- INDENT WORKFLOW ---
        const showIndentView = () => {
            if (currentUserRole === 'Admin') {
                renderIndentStatusView();
                navigate('indent-status-view');
            } else {
                navigate('indent-options-view');
            }
        };

        const addIndentRow = () => {
            const tbody = document.getElementById('indent-items-table');
            const row = document.createElement('tr');
            const serialNumber = tbody.children.length + 1;
            // UPDATED: Populate dropdown with real stationary list
            row.innerHTML = `
                <td class="px-4 py-2 serial-number">${serialNumber}</td>
                <td class="px-4 py-2">
                    <select class="w-full p-2 border rounded-md item-input" required>
                        <option value="" disabled selected>Select an item</option>
                        ${STATIONARY_LIST.map(c => `<option value="${c}">${c}</option>`).join('')}
                    </select>
                </td>
                <td class="px-4 py-2"><input type="number" placeholder="Qty" min="1" class="w-full p-2 border rounded-md quantity-input" required></td>
                <td class="px-4 py-2 text-center"><button type="button" class="delete-indent-row-btn text-red-500 hover:text-red-700 font-semibold">Remove</button></td>
            `;
            tbody.appendChild(row);
            row.querySelector('.delete-indent-row-btn').addEventListener('click', () => {
                row.remove();
                renumberIndentRows();
            });
        };
        
        const renumberIndentRows = () => {
            const rows = document.querySelectorAll('#indent-items-table .serial-number');
            rows.forEach((cell, index) => {
                cell.textContent = index + 1;
            });
        };
        
        const handleIndentSubmit = (e) => {
            e.preventDefault();
            const rows = document.querySelectorAll('#indent-items-table tr');
            if (rows.length === 0) return showToast('Please add at least one item to the indent.');
            
            const items = Array.from(rows).map(row => ({
                item: row.querySelector('.item-input').value,
                quantity: row.querySelector('.quantity-input').value
            })).filter(i => i.item && i.quantity); // Filter out empty/unselected rows

            if (items.length === 0) return showToast('Please fill out at least one item row.');

            const newIndent = {
                id: document.getElementById('indent-no').textContent,
                date: document.getElementById('indent-date').textContent,
                department: state.department,
                orderedBy: document.getElementById('indent-ordered-by').value,
                items: items, // Items now just have {item, quantity}
                status: 'Pending'
            };
            indentsLog.unshift(newIndent);
            saveData(); // Use main save function
            showToast('Indent submitted successfully!');
            navigate('user-dashboard-view');
        };

        const renderIndentForm = () => {
            document.getElementById('indent-dept-name').textContent = state.department;
            document.getElementById('indent-no').textContent = `IND-${Date.now()}`;
            document.getElementById('indent-date').textContent = new Date().toLocaleDateString('en-IN');
            const indentTableBody = document.getElementById('indent-items-table');
            indentTableBody.innerHTML = '';
            for(let i=0; i<10; i++) { addIndentRow(); } // Add 10 empty rows initially
            document.getElementById('indent-form').reset();
            navigate('indent-form-view');
        };

        const renderIndentStatusView = () => {
            const isAdmin = currentUserRole === 'Admin';
            document.getElementById('indent-history-admin-section').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('indents-status-header').textContent = isAdmin ? 'Action' : 'Status';
            document.getElementById('pending-indents-title').textContent = isAdmin ? 'Pending Indents' : 'My Indent Status';
            
            if (isAdmin) {
                const historyTbody = document.getElementById('indent-history-table');
                historyTbody.innerHTML = '';
                const history = indentsLog.filter(i => i.status === 'Solved' || i.status === 'Rejected'); // Show solved and rejected
                if (history.length === 0) { historyTbody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-slate-500">No historical indents.</td></tr>`; }
                else {
                    history.forEach(indent => {
                        const statusColor = indent.status === 'Solved' ? 'text-green-600' : 'text-red-600';
                        const row = document.createElement('tr');
                        
                        // Check if items have been reviewed, if so, show details
                        let itemsHTML = '';
                        if (indent.items && indent.items[0].itemStatus) {
                             itemsHTML = indent.items.map(i => {
                                let color = 'text-green-600';
                                if (i.itemStatus === 'Rejected' || i.approvedQty == 0) color = 'text-red-600';
                                else if (i.itemStatus === 'Partial' || i.approvedQty < i.quantity) color = 'text-amber-600';
                                return `<span class="${color}">${i.item} (Approved: ${i.approvedQty || 0}/${i.quantity})</span>`;
                            }).join('<br>');
                        } else {
                            itemsHTML = indent.items.map(i => `${i.item} (x${i.quantity})`).join('<br>');
                        }

                        row.innerHTML = `<td class="px-6 py-4">${indent.date}</td><td class="px-6 py-4">${indent.id}</td><td class="px-6 py-4 font-semibold">${indent.department}</td><td class="px-6 py-4 text-sm">${itemsHTML}</td><td class="px-6 py-4 font-bold ${statusColor}">${indent.status}</td>`;
                        historyTbody.appendChild(row);
                    });
                }
            }

            const pendingTbody = document.getElementById('pending-indents-table');
            pendingTbody.innerHTML = '';
            
            // User sees Pending, In Progress, Solved, Rejected. Admin sees Pending, In Progress.
            const pending = isAdmin 
                ? indentsLog.filter(i => i.status === 'Pending' || i.status === 'In Progress') 
                : indentsLog.filter(i => i.department === state.department);
                
            if (pending.length === 0) { pendingTbody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-slate-500">No indents found.</td></tr>`; return; }
            
            pending.forEach(indent => {
                const row = document.createElement('tr');
                let statusCellHTML = '';
                
                // Logic for Admin's action cell
                if (isAdmin) {
                    if (indent.status === 'Pending') {
                        statusCellHTML = `<td class="px-6 py-4 space-x-2"><button data-indent-id="${indent.id}" class="review-indent-btn bg-blue-500 text-white px-3 py-1 rounded-md text-sm">Review</button><button data-indent-id="${indent.id}" class="reject-indent-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm">Reject</button></td>`;
                    } else if (indent.status === 'In Progress') {
                        statusCellHTML = `<td class="px-6 py-4"><select data-indent-id="${indent.id}" class="indent-status-change p-2 border rounded-md"><option value="In Progress" selected>In Progress</option><option value="Solved">Mark as Solved</option></select></td>`;
                    }
                } else { // Logic for User's status cell
                    const color = indent.status === 'Pending' ? 'text-yellow-600' : indent.status === 'In Progress' ? 'text-blue-600' : indent.status === 'Solved' ? 'text-green-600' : 'text-red-600';
                    statusCellHTML = `<td class="px-6 py-4 font-semibold ${color}">${indent.status}</td>`;
                }
                
                // Logic for User's item list
                let itemsHTML = '';
                if (indent.status === 'Pending' || !indent.items[0].itemStatus) { // Show basic list if pending or not yet reviewed
                    itemsHTML = indent.items.map(i => `${i.item} (x${i.quantity})`).join('<br>');
                } else {
                    // Show detailed feedback if available (for In Progress, Solved, Rejected)
                    itemsHTML = indent.items.map(i => {
                        let color = 'text-slate-700';
                        if (i.itemStatus === 'Rejected' || i.approvedQty == 0) color = 'text-red-600 line-through';
                        else if (i.itemStatus === 'Partial' || (i.approvedQty < i.quantity)) color = 'text-amber-600';
                        else if (i.itemStatus === 'Approved') color = 'text-green-600';
                        
                        return `<span class="${color}">${i.item} (Approved: ${i.approvedQty || 0}/${i.quantity})</span>`;
                    }).join('<br>');
                }

                row.innerHTML = `<td class="px-6 py-4">${indent.date}</td><td class="px-6 py-4">${indent.id}</td><td class="px-6 py-4 font-semibold">${indent.department}</td><td class="px-6 py-4 text-sm">${itemsHTML}</td>${statusCellHTML}`;
                pendingTbody.appendChild(row);
            });
            
            document.querySelectorAll('.indent-status-change').forEach(sel => sel.addEventListener('change', (e) => handleIndentAction(e.target.dataset.indentId, e.target.value)));
            document.querySelectorAll('.review-indent-btn').forEach(btn => btn.addEventListener('click', (e) => showIndentReview(e.target.dataset.indentId)));
            document.querySelectorAll('.reject-indent-btn').forEach(btn => btn.addEventListener('click', (e) => handleIndentAction(e.target.dataset.indentId, 'Rejected')));
        };
        
        // This function now handles simple status changes (like Reject or Mark as Solved)
        const handleIndentAction = (indentId, newStatus) => {
            const indent = indentsLog.find(i => i.id == indentId);
            if(!indent) return;
            
            indent.status = newStatus;
            
            // If admin rejects the whole indent, mark all items as rejected
            if (newStatus === 'Rejected') {
                indent.items.forEach(item => {
                    item.approvedQty = 0;
                    item.itemStatus = 'Rejected';
                });
            }
            
            saveData(); // Use main save function
            showToast(`Indent status updated to "${newStatus}"!`);
            renderIndentStatusView();
        };

        // NEW FUNCTION: Show the detailed review page
        const showIndentReview = (indentId) => {
            const indent = indentsLog.find(i => i.id == indentId);
            if (!indent) return;
            
            document.getElementById('review-indent-id').value = indentId;
            document.getElementById('review-indent-no').textContent = indent.id;
            document.getElementById('review-indent-dept').textContent = indent.department;
            document.getElementById('review-indent-date').textContent = indent.date;
            document.getElementById('review-indent-ordered').textContent = indent.orderedBy;
            
            const reviewTbody = document.getElementById('indent-review-items-table');
            reviewTbody.innerHTML = '';
            
            indent.items.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-2">${index + 1}</td>
                    <td class="px-4 py-2">${item.item}</td>
                    <td class="px-4 py-2">${item.quantity}</td>
                    <td class="px-4 py-2">
                        <input type="number" class="w-full p-2 border rounded-md approved-qty-input" value="${item.quantity}" min="0" max="${item.quantity}">
                    </td>
                    <td class="px-4 py-2">
                        <select class="w-full p-2 border rounded-md item-status-select">
                            <option value="Approved" selected>Approved</option>
                            <option value="Partial">Partial</option>
                            <option value="Rejected">Rejected</option>
                            <option value="Out of Stock">Out of Stock</option>
                        </select>
                    </td>
                `;
                reviewTbody.appendChild(row);
            });
            
            navigate('indent-review-view');
        };

        // NEW FUNCTION: Handle the submission of the review form
        const handleIndentReviewSubmit = (e) => {
            e.preventDefault();
            const indentId = document.getElementById('review-indent-id').value;
            const indent = indentsLog.find(i => i.id == indentId);
            if (!indent) return;
            
            const reviewRows = document.querySelectorAll('#indent-review-items-table tr');
            let allRejected = true;
            
            reviewRows.forEach((row, index) => {
                const approvedQty = row.querySelector('.approved-qty-input').value;
                const itemStatus = row.querySelector('.item-status-select').value;
                
                indent.items[index].approvedQty = approvedQty;
                indent.items[index].itemStatus = itemStatus;
                
                if (itemStatus !== 'Rejected' && approvedQty > 0) {
                    allRejected = false;
                }
            });
            
            // If all items are rejected, mark the whole indent as Rejected
            indent.status = allRejected ? 'Rejected' : 'In Progress';
            
            saveData(); // Use main save function
            showToast('Indent processed successfully!');
            renderIndentStatusView();
            navigate('indent-status-view');
        };

        // --- UPDATED: Stationary Upload Workflow ---
        const renderStationaryUploadPage = () => {
            const isAdmin = currentUserRole === 'Admin';
            
            // Show/hide elements based on role
            document.getElementById('stationary-upload-form-container').style.display = isAdmin ? 'none' : 'block';
            document.getElementById('stationary-pending-section').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('stationary-upload-title').textContent = isAdmin ? 'Manage Stationary' : 'Upload New Stationary';
            document.getElementById('stationary-upload-desc').textContent = isAdmin ? 'Approve or reject new stationary requests.' : 'Request new stationary items to be approved by the admin.';
            document.getElementById('stationary-list-title').textContent = isAdmin ? 'Approved Stationary List' : 'My Stationary Requests';

            if (isAdmin) {
                // Admin: Render Pending Requests table
                const pendingTbody = document.getElementById('stationary-pending-table-body');
                pendingTbody.innerHTML = '';
                const pendingRequests = stationaryRequestsLog.filter(r => r.status === 'Pending');
                
                if (pendingRequests.length === 0) {
                    pendingTbody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-slate-500">No pending stationary requests.</td></tr>`;
                } else {
                    pendingRequests.forEach(req => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-slate-50';
                        row.innerHTML = `
                            <td class="px-6 py-4 font-semibold">${req.department}</td>
                            <td class="px-6 py-4 font-semibold">${req.name}</td>
                            <td class="px-6 py-4 text-sm text-slate-600">${req.desc}</td>
                            <td class="px-6 py-4">${req.quantity}</td>
                            <td class="px-6 py-4 space-x-2">
                                <button data-id="${req.id}" class="stationary-accept-btn bg-green-500 text-white px-3 py-1 rounded-md text-sm">Accept</button>
                                <button data-id="${req.id}" class="stationary-reject-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm">Reject</button>
                            </td>
                        `;
                        pendingTbody.appendChild(row);
                    });
                }

                // Admin: Render Approved Stationary table
                const approvedTbody = document.getElementById('stationary-upload-table-body');
                document.getElementById('stationary-list-header-row').innerHTML = `
                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Description</th>
                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Quantity</th>
                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Action</th>
                `;
                approvedTbody.innerHTML = '';
                if (stationaryUploadData.length === 0) {
                    approvedTbody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-slate-500">No approved stationary items.</td></tr>`;
                    return;
                }
                stationaryUploadData.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-slate-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 font-semibold">${item.name}</td>
                        <td class="px-6 py-4 text-sm text-slate-600">${item.desc}</td>
                        <td class="px-6 py-4">${item.quantity}</td>
                        <td class="px-6 py-4">
                            <button data-id="${item.id}" class="delete-other-btn text-red-600 font-semibold text-sm">Delete</button>
                        </td>
                    `;
                    approvedTbody.appendChild(row);
                });

            } else {
                // User: Render "My Requests" table
                const myRequestsTbody = document.getElementById('stationary-upload-table-body');
                document.getElementById('stationary-list-header-row').innerHTML = `
                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Description</th>
                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Quantity</th>
                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Status</th>
                `;
                myRequestsTbody.innerHTML = '';
                const myRequests = stationaryRequestsLog.filter(r => r.department === state.department);
                
                if (myRequests.length === 0) {
                    myRequestsTbody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-slate-500">You have not made any stationary requests.</td></tr>`;
                    return;
                }
                myRequests.forEach(req => {
                    const statusColor = req.status === 'Approved' ? 'text-green-600' : req.status === 'Pending' ? 'text-yellow-600' : 'text-red-600';
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-slate-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 font-semibold">${req.name}</td>
                        <td class="px-6 py-4 text-sm text-slate-600">${req.desc}</td>
                        <td class="px-6 py-4">${req.quantity}</td>
                        <td class="px-6 py-4 font-semibold ${statusColor}">${req.status}</td>
                    `;
                    myRequestsTbody.appendChild(row);
                });
            }
        };

        const handleStationaryUploadSubmit = (e) => {
            e.preventDefault();
            const newItem = {
                id: `STATREQ-${Date.now()}`,
                department: state.department,
                name: document.getElementById('other-name').value,
                quantity: document.getElementById('other-quantity').value,
                image: '', // Image field removed
                desc: document.getElementById('other-desc').value,
                status: 'Pending'
            };
            
            stationaryRequestsLog.unshift(newItem); // Add to the requests log
            saveData();
            showToast('New stationary request submitted!');
            document.getElementById('stationary-upload-form').reset();
            renderStationaryUploadPage(); // Refresh the user's list
        };
        
        const handleStationaryRequestAction = (id, action) => {
            const request = stationaryRequestsLog.find(r => r.id == id); // Use == for ID
            if (!request) return;

            if (action === 'Approved') {
                request.status = 'Approved';
                // Add to the permanent "stationaryUploadData" list
                const newItem = {
                    id: request.id,
                    name: request.name,
                    quantity: request.quantity,
                    desc: request.desc,
                    image: ''
                };
                stationaryUploadData.unshift(newItem);
                showToast('Request approved and item added.');
            } else {
                request.status = 'Rejected';
                showToast('Request rejected.');
            }
            saveData();
            renderStationaryUploadPage();
        };

        const handleStationaryUploadDelete = (id) => {
            if (confirm('Are you sure you want to delete this approved item? This cannot be undone.')) {
                stationaryUploadData = stationaryUploadData.filter(item => item.id != id); // Use != for ID
                // Optional: Also remove from the requests log
                const request = stationaryRequestsLog.find(r => r.id == id);
                if (request) request.status = 'Deleted/Removed';
                
                saveData();
                showToast('Item deleted.');
                renderStationaryUploadPage();
            }
        };
        // --- END OTHERS UPDATE ---


        // --- MODAL & FORM LOGIC ---
        const openModal = (operation, asset = null) => {
            const form = document.getElementById('asset-form'); form.reset();
            document.getElementById('modal-operation').value = operation;
            document.getElementById('delete-message').classList.add('hidden');
            
            // UPDATED: This modal is only for the simple stationary list
            document.getElementById('asset-name-static').value = asset.name;
            document.getElementById('asset-quantity').value = asset.quantity;
            document.getElementById('asset-original-id').value = asset.name; // Use name as the ID

            document.getElementById('modal-title').textContent = `Edit Quantity for: ${asset.name}`; 
            document.getElementById('modal-submit-btn').textContent = 'Update Quantity';
            
            // This logic is all hidden now
            document.getElementById('asset-id-group').style.display = 'none';
            document.getElementById('asset-name-group').style.display = 'none';
            document.getElementById('asset-location-group').style.display = 'none';
            document.getElementById('asset-brand-group').style.display = 'none';
            document.getElementById('asset-status-group').style.display = 'none';

            document.getElementById('asset-modal').style.display = 'flex';
        };

        const handleFormSubmit = (e) => {
            e.preventDefault();
            const operation = document.getElementById('modal-operation').value;
            // UPDATED: Use name as the ID
            const originalName = document.getElementById('asset-original-id').value;

            if (operation === 'edit') {
                const ref = findAssetReference(originalName);
                if (ref) {
                    ref.asset.quantity = parseInt(document.getElementById('asset-quantity').value) || 0;
                }
            } else {
                // 'delete' and 'add' are no longer used by this modal
                console.warn('Unsupported operation in handleFormSubmit');
            }

            saveData(); 
            document.getElementById('asset-modal').style.display = 'none'; 
            renderCategoryDetail();
            showToast(`Quantity updated successfully!`);
        };
        
        // --- BULK ACTIONS (Kept, but not used by new table) ---
        const toggleItemSelection = (e, id) => { if (e.target.checked) state.selectedItems.add(id); else state.selectedItems.delete(id); updateBulkActionButton(); };
        const toggleAllItems = (e) => {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            const assetIds = Array.from(checkboxes).map(cb => cb.dataset.itemId);
            state.selectedItems.clear();
            if (e.target.checked) assetIds.forEach(id => state.selectedItems.add(id));
            checkboxes.forEach(cb => cb.checked = e.target.checked);
            renderCategoryDetail();
        };
        const updateBulkActionButton = () => { const btn = document.getElementById('bulk-action-btn'); btn.innerHTML = `Bulk Actions (${state.selectedItems.size})`; btn.disabled = state.selectedItems.size === 0; };
        const openBulkModal = (type) => {
           // This function is no longer used by the new table
        };
        const handleBulkActionSubmit = (e) => {
            e.preventDefault();
            // This function is no longer connected to the new stationary table
        };

        // --- CHARTING & DOWNLOADS ---
        const renderDepartmentChart = (categoryCounts) => {
            // This function is no longer used, but kept
        };
        
        const renderCategoryChart = (assets) => {
            // This chart is hidden, so we do nothing
        };
        
        const exportToExcel = (data, filename) => {
            // This function is no longer connected to a button
        };
        
        // --- EVENT LISTENERS ---
        // Download buttons are hidden
        // document.getElementById('download-all-btn').addEventListener('click', ...);
        // document.getElementById('download-current-btn').addEventListener('click', ...);

        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('logout-btn').addEventListener('click', handleLogout);

        // --- NEW PASSWORD TOGGLE LISTENER ---
        document.getElementById('toggle-password').addEventListener('click', (e) => {
            e.preventDefault(); 
            const passwordField = document.getElementById('login-password');
            const eyeIcon = e.currentTarget.querySelector('svg'); 

            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                eyeIcon.classList.remove('text-slate-400');
                eyeIcon.classList.add('text-teal-600'); // Active color
            } else {
                passwordField.type = 'password';
                eyeIcon.classList.add('text-slate-400');
                eyeIcon.classList.remove('text-teal-600'); // Inactive color
            }
        });
        // --- END NEW LISTENER ---

        document.getElementById('back-to-depts').addEventListener('click', () => { state.department = null; navigate('departments-view'); renderDepartments(); });
        document.getElementById('back-to-user-dashboard').addEventListener('click', () => navigate('user-dashboard-view'));
        
        // UPDATED: Inventory button now goes directly to the item list
        document.getElementById('go-to-inventory-btn').addEventListener('click', () => { 
            if (state.department) { 
                state.category = 'Stationary';
                renderCategoryDetail(); 
                navigate('category-detail-view'); 
            } 
        });
        
        // UPDATED: Back button goes to dashboard
        document.getElementById('back-to-categories').addEventListener('click', () => { 
            navigate(currentUserRole === 'Admin' ? 'departments-view' : 'user-dashboard-view');
        });
        
        // These are no longer visible, but listeners are kept
        document.getElementById('search-input').addEventListener('input', (e) => { state.searchText = e.target.value; renderCategoryDetail(); });
        document.getElementById('status-filter').addEventListener('change', (e) => { state.filterStatus = e.target.value; renderCategoryDetail(); });
        document.getElementById('action-add-item').addEventListener('click', () => openModal('add'));
        
        document.getElementById('cancel-modal-btn').addEventListener('click', () => document.getElementById('asset-modal').style.display = 'none');
        document.getElementById('asset-form').addEventListener('submit', handleFormSubmit);
        
        // These are no longer visible, but listeners are kept
        document.getElementById('bulk-action-btn').addEventListener('click', () => document.getElementById('bulk-action-dropdown').classList.toggle('hidden'));
        document.getElementById('bulk-status-btn').addEventListener('click', () => openBulkModal('status'));
        document.getElementById('bulk-move-btn').addEventListener('click', () => openBulkModal('move'));
        document.getElementById('bulk-delete-btn').addEventListener('click', () => openBulkModal('delete'));
        document.getElementById('bulk-cancel-btn').addEventListener('click', () => document.getElementById('bulk-action-modal').style.display = 'none');
        document.getElementById('bulk-action-form').addEventListener('submit', handleBulkActionSubmit);
        
        // --- UPDATED EVENT LISTENERS (with null checks) ---
        const adminAssignBtn = document.getElementById('admin-assign-btn');
        if (adminAssignBtn) {
            adminAssignBtn.addEventListener('click', showAssignView);
        }
        
        const userAssignBtn = document.getElementById('user-assign-btn');
        if (userAssignBtn) {
            userAssignBtn.addEventListener('click', showAssignView);
        }
        
        const adminRequestsBtn = document.getElementById('admin-requests-btn');
        if (adminRequestsBtn) {
            adminRequestsBtn.addEventListener('click', showRequestsView);
        }
        
        document.getElementById('user-requests-btn').addEventListener('click', showRequestsView);
        document.getElementById('assign-form').addEventListener('submit', handleAssignmentSubmit);
        document.getElementById('back-from-assign').addEventListener('click', () => navigate(currentUserRole === 'Admin' ? 'departments-view' : 'user-dashboard-view'));
        document.getElementById('back-from-requests').addEventListener('click', () => navigate(currentUserRole === 'Admin' ? 'departments-view' : 'user-dashboard-view'));

        // INDENT LISTENERS
        document.getElementById('user-indent-btn').addEventListener('click', showIndentView);
        document.getElementById('admin-indents-btn').addEventListener('click', showIndentView);
        document.getElementById('go-to-indent-form-btn').addEventListener('click', renderIndentForm);
        document.getElementById('go-to-indent-status-btn').addEventListener('click', () => { renderIndentStatusView(); navigate('indent-status-view'); });
        document.getElementById('back-from-indent-options').addEventListener('click', () => navigate('user-dashboard-view'));
        document.getElementById('back-from-indent-form').addEventListener('click', () => navigate('indent-options-view'));
        document.getElementById('back-from-indent-status').addEventListener('click', () => navigate(currentUserRole === 'Admin' ? 'departments-view' : 'indent-options-view'));
        document.getElementById('add-indent-row-btn').addEventListener('click', addIndentRow);
        document.getElementById('indent-form').addEventListener('submit', handleIndentSubmit);
        
        // Indent Review page
        document.getElementById('back-from-indent-review').addEventListener('click', () => navigate('indent-status-view'));
        document.getElementById('indent-review-form').addEventListener('submit', handleIndentReviewSubmit);

        // OTHERS UPDATE: Add event listeners
        document.getElementById('go-to-stationary-upload-btn').addEventListener('click', () => {
            renderStationaryUploadPage();
            navigate('stationary-upload-view');
        });
        document.getElementById('admin-stationary-upload-btn').addEventListener('click', () => {
            renderStationaryUploadPage();
            navigate('stationary-upload-view');
        });
        document.getElementById('back-from-stationary-upload').addEventListener('click', () => {
            navigate(currentUserRole === 'Admin' ? 'departments-view' : 'user-dashboard-view');
        });
        document.getElementById('stationary-upload-form').addEventListener('submit', handleStationaryUploadSubmit);
        
        // UPDATED: Event listener for both tables
        document.getElementById('stationary-upload-table-body').addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-other-btn')) {
                handleStationaryUploadDelete(e.target.dataset.id);
            }
        });
        document.getElementById('stationary-pending-table-body').addEventListener('click', (e) => {
            if (e.target.classList.contains('stationary-accept-btn')) {
                handleStationaryRequestAction(e.target.dataset.id, 'Approved');
            }
            if (e.target.classList.contains('stationary-reject-btn')) {
                handleStationaryRequestAction(e.target.dataset.id, 'Rejected');
            }
        });


        // --- INITIAL LOAD ---
        loadData();
    });
    </script>
</body>
</html>
